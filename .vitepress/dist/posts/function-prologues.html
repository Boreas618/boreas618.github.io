<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Function Prologues | Yi Sun's Blog</title>
    <meta name="description" content="This is Yi Sun's blog.">
    <link rel="preload stylesheet" href="/assets/style.2b7f4062.css" as="style">
    
    <script type="module" src="/assets/app.22cac881.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/framework.5ae544db.js">
    <link rel="modulepreload" href="/assets/chunks/theme.a033d0b2.js">
    <link rel="modulepreload" href="/assets/posts_function-prologues.md.b764e00b.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-9d8abc1e><!--[--><!--]--><!--[--><span tabindex="-1" data-v-c8291ffa></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-c8291ffa> Skip to content </a><!--]--><!----><header class="VPNav" data-v-9d8abc1e data-v-7ad780c2><div class="VPNavBar has-sidebar" data-v-7ad780c2 data-v-f1abbc6e><div class="container" data-v-f1abbc6e><div class="title" data-v-f1abbc6e><div class="VPNavBarTitle has-sidebar" data-v-f1abbc6e data-v-2973dbb4><a class="title" href="/" data-v-2973dbb4><!--[--><!--]--><!----><!--[-->Yi Sun&#39;s Blog<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-f1abbc6e><div class="curtain" data-v-f1abbc6e></div><div class="content-body" data-v-f1abbc6e><!--[--><!--]--><div class="VPNavBarSearch search" data-v-f1abbc6e><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-f1abbc6e data-v-f732b5d0><span id="main-nav-aria-label" class="visually-hidden" data-v-f732b5d0>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/" tabindex="0" data-v-f732b5d0 data-v-cb318fec><!--[--><span data-v-cb318fec>Me</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/posts/monitor.html" tabindex="0" data-v-f732b5d0 data-v-cb318fec><!--[--><span data-v-cb318fec>Posts</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/papers/TreeSLS.html" tabindex="0" data-v-f732b5d0 data-v-cb318fec><!--[--><span data-v-cb318fec>Paper Reading</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-f1abbc6e data-v-283b26e9><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-283b26e9 data-v-3329432d data-v-1c29e291><span class="check" data-v-1c29e291><span class="icon" data-v-1c29e291><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-3329432d><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-3329432d><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-f1abbc6e data-v-ef6192dc data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/boreas618" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-16cf740a><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-f1abbc6e data-v-c8c2ae4b data-v-aa8de344><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-aa8de344><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-aa8de344><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-aa8de344><div class="VPMenu" data-v-aa8de344 data-v-e42ed9b3><!----><!--[--><!--[--><!----><div class="group" data-v-c8c2ae4b><div class="item appearance" data-v-c8c2ae4b><p class="label" data-v-c8c2ae4b>Appearance</p><div class="appearance-action" data-v-c8c2ae4b><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-c8c2ae4b data-v-3329432d data-v-1c29e291><span class="check" data-v-1c29e291><span class="icon" data-v-1c29e291><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-3329432d><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-3329432d><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-c8c2ae4b><div class="item social-links" data-v-c8c2ae4b><div class="VPSocialLinks social-links-list" data-v-c8c2ae4b data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/boreas618" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-16cf740a><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-f1abbc6e data-v-6bee1efd><span class="container" data-v-6bee1efd><span class="top" data-v-6bee1efd></span><span class="middle" data-v-6bee1efd></span><span class="bottom" data-v-6bee1efd></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav reached-top" data-v-9d8abc1e data-v-9e669cc1><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-9e669cc1><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-9e669cc1><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-9e669cc1>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-9e669cc1 data-v-24251f6f><button data-v-24251f6f>Return to top</button><!----></div></div><aside class="VPSidebar" data-v-9d8abc1e data-v-ee2efba5><div class="curtain" data-v-ee2efba5></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-ee2efba5><span class="visually-hidden" id="sidebar-aria-label" data-v-ee2efba5> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-ee2efba5><section class="VPSidebarItem level-0 has-active" data-v-ee2efba5 data-v-bd01e0d5><!----><div class="items" data-v-bd01e0d5><!--[--><div class="VPSidebarItem level-1 is-link" data-v-bd01e0d5 data-v-bd01e0d5><div class="item" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><a class="VPLink link link" href="/posts/monitor.html" data-v-bd01e0d5><!--[--><p class="text" data-v-bd01e0d5>Monitor, Condition Variables and Three Semantics</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-bd01e0d5 data-v-bd01e0d5><div class="item" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><a class="VPLink link link" href="/posts/xv6-trap.html" data-v-bd01e0d5><!--[--><p class="text" data-v-bd01e0d5>Exception and Interrupt Handling in xv6</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-bd01e0d5 data-v-bd01e0d5><div class="item" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><a class="VPLink link link" href="/posts/function-prologues.html" data-v-bd01e0d5><!--[--><p class="text" data-v-bd01e0d5>Function Prologues</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-9d8abc1e data-v-3cf691b6><div class="VPDoc has-sidebar has-aside" data-v-3cf691b6 data-v-a3c25e27><!--[--><!--]--><div class="container" data-v-a3c25e27><div class="aside" data-v-a3c25e27><div class="aside-curtain" data-v-a3c25e27></div><div class="aside-container" data-v-a3c25e27><div class="aside-content" data-v-a3c25e27><div class="VPDocAside" data-v-a3c25e27 data-v-cb998dce><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-cb998dce data-v-3a6c4994><div class="content" data-v-3a6c4994><div class="outline-marker" data-v-3a6c4994></div><div class="outline-title" role="heading" aria-level="2" data-v-3a6c4994>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-3a6c4994><span class="visually-hidden" id="doc-outline-aria-label" data-v-3a6c4994> Table of Contents for current page </span><ul class="root" data-v-3a6c4994 data-v-463da30f><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-cb998dce></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-a3c25e27><div class="content-container" data-v-a3c25e27><!--[--><!--]--><!----><main class="main" data-v-a3c25e27><div style="position:relative;" class="vp-doc _posts_function-prologues" data-v-a3c25e27><div><h1 id="function-prologues" tabindex="-1">Function Prologues <a class="header-anchor" href="#function-prologues" aria-label="Permalink to &quot;Function Prologues&quot;">​</a></h1><p><strong>Definition</strong>: In assembly language programming, the <strong>function prologue</strong> is a few lines of code at the beginning of a function, which prepare the stack and registers for use within the function [1].</p><p>We will explore function prologues with respect to different ISAs and different compilers in this post. To illustrate, a simple C program and its corresponding assembly code under different settings are presented.</p><p>Consider the following C code:</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">add_one</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">a</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">add_two</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">a</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">add_one</span><span style="color:#E1E4E8;">(a</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> b </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">add_two</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">add_one</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#E36209;">a</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">add_two</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#E36209;">a</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">add_one</span><span style="color:#24292E;">(a</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> b </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">add_two</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>The assembly code for <code>add_two</code> given by <code>x86-64 clang 17.0.1</code> is (We start by <code>add_two</code> because the assembly code for it is more clear and general):</p><div class="language-assembly vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">assembly</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">add_two:                                # @add_two</span></span>
<span class="line"><span style="color:#e1e4e8;">        pushq   %rbp</span></span>
<span class="line"><span style="color:#e1e4e8;">        movq    %rsp, %rbp</span></span>
<span class="line"><span style="color:#e1e4e8;">        subq    $16, %rsp</span></span>
<span class="line"><span style="color:#e1e4e8;">        movl    %edi, -4(%rbp)</span></span>
<span class="line"><span style="color:#e1e4e8;">        movl    -4(%rbp), %edi</span></span>
<span class="line"><span style="color:#e1e4e8;">        addl    $1, %edi</span></span>
<span class="line"><span style="color:#e1e4e8;">        callq   add_one</span></span>
<span class="line"><span style="color:#e1e4e8;">        addq    $16, %rsp</span></span>
<span class="line"><span style="color:#e1e4e8;">        popq    %rbp</span></span>
<span class="line"><span style="color:#e1e4e8;">        retq</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">add_two:                                # @add_two</span></span>
<span class="line"><span style="color:#24292e;">        pushq   %rbp</span></span>
<span class="line"><span style="color:#24292e;">        movq    %rsp, %rbp</span></span>
<span class="line"><span style="color:#24292e;">        subq    $16, %rsp</span></span>
<span class="line"><span style="color:#24292e;">        movl    %edi, -4(%rbp)</span></span>
<span class="line"><span style="color:#24292e;">        movl    -4(%rbp), %edi</span></span>
<span class="line"><span style="color:#24292e;">        addl    $1, %edi</span></span>
<span class="line"><span style="color:#24292e;">        callq   add_one</span></span>
<span class="line"><span style="color:#24292e;">        addq    $16, %rsp</span></span>
<span class="line"><span style="color:#24292e;">        popq    %rbp</span></span>
<span class="line"><span style="color:#24292e;">        retq</span></span></code></pre></div><p>The function prologue for <code>add_two</code> can be extracted as:</p><div class="language-assembly vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">assembly</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">add_two:                                # @add_two</span></span>
<span class="line"><span style="color:#e1e4e8;">        pushq   %rbp</span></span>
<span class="line"><span style="color:#e1e4e8;">        movq    %rsp, %rbp</span></span>
<span class="line"><span style="color:#e1e4e8;">        subq    $16, %rsp</span></span>
<span class="line"><span style="color:#e1e4e8;">        movl    %edi, -4(%rbp)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">add_two:                                # @add_two</span></span>
<span class="line"><span style="color:#24292e;">        pushq   %rbp</span></span>
<span class="line"><span style="color:#24292e;">        movq    %rsp, %rbp</span></span>
<span class="line"><span style="color:#24292e;">        subq    $16, %rsp</span></span>
<span class="line"><span style="color:#24292e;">        movl    %edi, -4(%rbp)</span></span></code></pre></div><p>Let&#39;s explain this function prologue line by line.</p><p>First, we execute <code>pushq %rbp</code> to save the current base pointer <code>%rbp</code> on the stack. This is crucial because <code>%rbp</code> is used as the stack-frame base pointer in the x86-64 calling convention, providing a stable reference point within the stack frame for the current procedure [2]. By saving <code>%rbp</code>, we preserve the calling procedure&#39;s (<code>main</code>) stack frame context, as <code>%rbp</code> will now be repurposed for the <code>add_two</code> procedure.</p><p>Next, <code>movq %rsp, %rbp</code> updates <code>%rbp</code> to the current stack pointer <code>%rsp</code>, effectively setting the new base pointer for the <code>add_two</code> stack frame. At this point, the stack frame of <code>add_two</code> includes two key elements:</p><ul><li><p><code>8(%rbp)</code> represents the return address. The <code>callq</code> instruction in <code>main</code> pushes the next instruction&#39;s address onto the stack before jumping to <code>add_two</code>. Hence, <code>%rsp</code> points to this return address <strong>upon entering <code>add_two</code></strong>.</p></li><li><p><code>0(%rbp)</code> is the original <code>%rbp</code> value, saved earlier. With the first two lines of the prologue, the stack now includes the return address and the previous <code>%rbp</code>, and the <code>%rsp</code> and the new <code>%rbp</code> points precisely to this saved original <code>%rbp</code> on the stack.</p><blockquote><p>The stack frame of a procedure <code>p</code> consists of data pushed to stack from the moment <code>call p</code> starts executing to the moment <code>call another_p</code> is going to execute.</p></blockquote><img src="https://p.ipic.vip/oozad7.png" alt="Screenshot 2023-11-22 at 11.48.03 PM" style="zoom:50%;"></li></ul><p>Then <code>subq $16, %rsp</code> is used to allocate a 16-byte stack space for the current procedure, <code>add_two</code>.</p><p>As we can see later, only 8 bytes of this space are used for storing the argument <code>int a</code>. The question then arises: why allocate an extra 8 bytes? According to the System V Application Binary Interface [3], which mandates that the end of the input argument area must align on a 16-byte boundary (or a 32-byte boundary if <code>__m256</code> is passed on the stack). In simpler terms, the stack frame size must be a multiple of 16 bytes (or 32 bytes if <code>__m256</code> is passed on the stack). However, for compilers which don&#39;t use the System V AMD64 ABI, like <code>gcc</code>, they may not enforce the 16-byte alignment [4].</p><p>Finally, the argument <code>int a</code> is moved from the register <code>%edi</code> to the memory position <code>-4(%rbp)</code>. This means the argument 0 is adjacent to the previous <code>%rbp</code> value on the stack with no gaps</p><p>Above is the work the function prologue does. It actually saves the <strong>caller-saved</strong> registers.</p><p>Hold on, isn&#39;t <code>add_two</code> the callee in this example?</p><p><strong>Actually, the function prologue saves these things under the assumption (for the purpose) that the procedure <code>add_two</code> may call other procedures later.</strong> Then, <code>add_two</code> is the caller, and it has to save the <strong>caller-saved</strong> registers. In other words, if the procedure does not call any other procedures, the function prologue can be omitted. We will see some examples later.</p><p>Before concluding this post, let&#39;s briefly examine the appearance of function prologues in RISC-V and AArch64.</p><p>For <code>RISC-V rv64gc clang 17.0.1</code> the function prologue of <code>add_two</code> can be given by:</p><div class="language-assembly vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">assembly</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">add_two:                                # @add_two</span></span>
<span class="line"><span style="color:#e1e4e8;">        addi    sp, sp, -32</span></span>
<span class="line"><span style="color:#e1e4e8;">        sd      ra, 24(sp)                      # 8-byte Folded Spill</span></span>
<span class="line"><span style="color:#e1e4e8;">        sd      s0, 16(sp)                      # 8-byte Folded Spill</span></span>
<span class="line"><span style="color:#e1e4e8;">        addi    s0, sp, 32</span></span>
<span class="line"><span style="color:#e1e4e8;">        sw      a0, -20(s0)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">add_two:                                # @add_two</span></span>
<span class="line"><span style="color:#24292e;">        addi    sp, sp, -32</span></span>
<span class="line"><span style="color:#24292e;">        sd      ra, 24(sp)                      # 8-byte Folded Spill</span></span>
<span class="line"><span style="color:#24292e;">        sd      s0, 16(sp)                      # 8-byte Folded Spill</span></span>
<span class="line"><span style="color:#24292e;">        addi    s0, sp, 32</span></span>
<span class="line"><span style="color:#24292e;">        sw      a0, -20(s0)</span></span></code></pre></div><p>The assembly code presented demonstrates that <code>s0</code> serves as the frame pointer in RISC-V architecture, analogous to <code>%rbp</code> in x86-64. The function prologue for <code>add_two</code> in RISC-V is different from its x86-64 counterpart in terms of:</p><ol><li>In RISC-V, the stack frame for <code>add_two</code> is allocated as soon as control flow enters the function.</li><li>The frame pointer (<code>s0</code>) references the bottom of the most recent stack frame, contrasting with x86-64 where it typically points to the position storing the previous stack-frame base pointer.</li></ol><p>For <code>armv8-a clang 17.0.1</code> the function prologue of <code>add_two</code> can be given by:</p><div class="language-assembly vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">assembly</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">add_two:                                // @add_two</span></span>
<span class="line"><span style="color:#e1e4e8;">        sub     sp, sp, #32</span></span>
<span class="line"><span style="color:#e1e4e8;">        stp     x29, x30, [sp, #16]             // 16-byte Folded Spill</span></span>
<span class="line"><span style="color:#e1e4e8;">        add     x29, sp, #16</span></span>
<span class="line"><span style="color:#e1e4e8;">        stur    w0, [x29, #-4]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">add_two:                                // @add_two</span></span>
<span class="line"><span style="color:#24292e;">        sub     sp, sp, #32</span></span>
<span class="line"><span style="color:#24292e;">        stp     x29, x30, [sp, #16]             // 16-byte Folded Spill</span></span>
<span class="line"><span style="color:#24292e;">        add     x29, sp, #16</span></span>
<span class="line"><span style="color:#24292e;">        stur    w0, [x29, #-4]</span></span></code></pre></div><p><code>x29</code> is equivalent to <code>s0</code>, and <code>x30</code> is equivalent to <code>ra</code>. The frame pointer (<code>x29</code>) points to the position where the previous <code>x29</code> is stored, similar to the approach used in x86-64.</p><blockquote><p><strong>Red Zone</strong></p><p>The 128-byte area beyond the location pointed to by <code>%rsp</code> is considered to be reserved and shall not be modified by signal or interrupt handlers. Therefore, functions may use this area for temporary data that is not needed across function calls. In particular, leaf functions may use this area for their entire stack frame, rather than adjusting the stack pointer in the prologue and epilogue. This area is known as the red zone [3].</p></blockquote><h2 id="references" tabindex="-1">References <a class="header-anchor" href="#references" aria-label="Permalink to &quot;References&quot;">​</a></h2><p><strong>1</strong> Function prologue and epilogue <a href="https://en.wikipedia.org/wiki/Function_prologue_and_epilogue" target="_blank" rel="noreferrer">https://en.wikipedia.org/wiki/Function_prologue_and_epilogue</a></p><p><strong>2</strong> Intel® 64 and IA-32 Architectures Software Developer&#39;s Manual Volume 1: Basic Architecture Chap. 6.2 (<a href="https://cdrdv2.intel.com/v1/dl/getContent/671436" target="_blank" rel="noreferrer">https://cdrdv2.intel.com/v1/dl/getContent/671436</a>)</p><p><strong>3</strong> System V Application Binary Interface <a href="https://refspecs.linuxbase.org/elf/x86_64-abi-0.99.pdf" target="_blank" rel="noreferrer">https://refspecs.linuxbase.org/elf/x86_64-abi-0.99.pdf</a></p><p><strong>4</strong> System V ABI - AMD64 - Stack alignment in GCC-emitted assembly <a href="https://stackoverflow.com/questions/64627897/system-v-abi-amd64-stack-alignment-in-gcc-emitted-assembly" target="_blank" rel="noreferrer">https://stackoverflow.com/questions/64627897/system-v-abi-amd64-stack-alignment-in-gcc-emitted-assembly</a></p></div></div></main><footer class="VPDocFooter" data-v-a3c25e27 data-v-a2d931e4><!--[--><!--]--><!----><nav class="prev-next" data-v-a2d931e4><div class="pager" data-v-a2d931e4><a class="pager-link prev" href="/posts/xv6-trap.html" data-v-a2d931e4><span class="desc" data-v-a2d931e4>Previous page</span><span class="title" data-v-a2d931e4>Exception and Interrupt Handling in xv6</span></a></div><div class="pager" data-v-a2d931e4><!----></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"papers_clof.md\":\"44d957b6\",\"papers_treesls.md\":\"7c7057bf\",\"posts_function-prologues.md\":\"b764e00b\",\"papers_transactional-memory.md\":\"5cfb513d\",\"papers_kuber-scheduling.md\":\"ca7bae1a\",\"posts_xv6-trap.md\":\"2fe1f712\",\"index.md\":\"2af00d05\",\"posts_monitor.md\":\"6d59b01b\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Yi Sun's Blog\",\"description\":\"This is Yi Sun's blog.\",\"base\":\"/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"Me\",\"link\":\"/\"},{\"text\":\"Posts\",\"link\":\"/posts/monitor\"},{\"text\":\"Paper Reading\",\"link\":\"/papers/TreeSLS\"}],\"sidebar\":{\"/\":{\"text\":\"Me\",\"items\":[{\"text\":\"Biograhy\",\"link\":\"/\"}]},\"/posts/\":{\"text\":\"Operating Systems\",\"items\":[{\"text\":\"Monitor, Condition Variables and Three Semantics\",\"link\":\"/posts/monitor\"},{\"text\":\"Exception and Interrupt Handling in xv6\",\"link\":\"/posts/xv6-trap\"},{\"text\":\"Function Prologues\",\"link\":\"/posts/function-prologues\"}]},\"/papers/\":[{\"text\":\"Operating Systems\",\"items\":[{\"text\":\"TreeSLS\",\"link\":\"/papers/TreeSLS\"},{\"text\":\"Transactional Memory\",\"link\":\"/papers/transactional-memory\"},{\"text\":\"Kubernetes Scheduling\",\"link\":\"/papers/kuber-scheduling\"},{\"text\":\"CLoF\",\"link\":\"/papers/CLoF\"}]},{\"text\":\"NLP\",\"items\":[]}]},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/boreas618\"}]},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":false}");</script>
    
  </body>
</html>