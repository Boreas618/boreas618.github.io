<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Exception and Interrupt Handling in xv6 | Yi Sun's Blog</title>
    <meta name="description" content="This is Yi Sun's blog.">
    <link rel="preload stylesheet" href="/assets/style.2b7f4062.css" as="style">
    
    <script type="module" src="/assets/app.22cac881.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/framework.5ae544db.js">
    <link rel="modulepreload" href="/assets/chunks/theme.a033d0b2.js">
    <link rel="modulepreload" href="/assets/posts_xv6-trap.md.2fe1f712.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-9d8abc1e><!--[--><!--]--><!--[--><span tabindex="-1" data-v-c8291ffa></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-c8291ffa> Skip to content </a><!--]--><!----><header class="VPNav" data-v-9d8abc1e data-v-7ad780c2><div class="VPNavBar has-sidebar" data-v-7ad780c2 data-v-f1abbc6e><div class="container" data-v-f1abbc6e><div class="title" data-v-f1abbc6e><div class="VPNavBarTitle has-sidebar" data-v-f1abbc6e data-v-2973dbb4><a class="title" href="/" data-v-2973dbb4><!--[--><!--]--><!----><!--[-->Yi Sun&#39;s Blog<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-f1abbc6e><div class="curtain" data-v-f1abbc6e></div><div class="content-body" data-v-f1abbc6e><!--[--><!--]--><div class="VPNavBarSearch search" data-v-f1abbc6e><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-f1abbc6e data-v-f732b5d0><span id="main-nav-aria-label" class="visually-hidden" data-v-f732b5d0>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/" tabindex="0" data-v-f732b5d0 data-v-cb318fec><!--[--><span data-v-cb318fec>Me</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/posts/monitor.html" tabindex="0" data-v-f732b5d0 data-v-cb318fec><!--[--><span data-v-cb318fec>Posts</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/papers/TreeSLS.html" tabindex="0" data-v-f732b5d0 data-v-cb318fec><!--[--><span data-v-cb318fec>Paper Reading</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-f1abbc6e data-v-283b26e9><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-283b26e9 data-v-3329432d data-v-1c29e291><span class="check" data-v-1c29e291><span class="icon" data-v-1c29e291><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-3329432d><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-3329432d><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-f1abbc6e data-v-ef6192dc data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/boreas618" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-16cf740a><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-f1abbc6e data-v-c8c2ae4b data-v-aa8de344><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-aa8de344><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-aa8de344><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-aa8de344><div class="VPMenu" data-v-aa8de344 data-v-e42ed9b3><!----><!--[--><!--[--><!----><div class="group" data-v-c8c2ae4b><div class="item appearance" data-v-c8c2ae4b><p class="label" data-v-c8c2ae4b>Appearance</p><div class="appearance-action" data-v-c8c2ae4b><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-c8c2ae4b data-v-3329432d data-v-1c29e291><span class="check" data-v-1c29e291><span class="icon" data-v-1c29e291><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-3329432d><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-3329432d><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-c8c2ae4b><div class="item social-links" data-v-c8c2ae4b><div class="VPSocialLinks social-links-list" data-v-c8c2ae4b data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/boreas618" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-16cf740a><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-f1abbc6e data-v-6bee1efd><span class="container" data-v-6bee1efd><span class="top" data-v-6bee1efd></span><span class="middle" data-v-6bee1efd></span><span class="bottom" data-v-6bee1efd></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav reached-top" data-v-9d8abc1e data-v-9e669cc1><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-9e669cc1><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-9e669cc1><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-9e669cc1>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-9e669cc1 data-v-24251f6f><button data-v-24251f6f>Return to top</button><!----></div></div><aside class="VPSidebar" data-v-9d8abc1e data-v-ee2efba5><div class="curtain" data-v-ee2efba5></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-ee2efba5><span class="visually-hidden" id="sidebar-aria-label" data-v-ee2efba5> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-ee2efba5><section class="VPSidebarItem level-0 has-active" data-v-ee2efba5 data-v-bd01e0d5><!----><div class="items" data-v-bd01e0d5><!--[--><div class="VPSidebarItem level-1 is-link" data-v-bd01e0d5 data-v-bd01e0d5><div class="item" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><a class="VPLink link link" href="/posts/monitor.html" data-v-bd01e0d5><!--[--><p class="text" data-v-bd01e0d5>Monitor, Condition Variables and Three Semantics</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-bd01e0d5 data-v-bd01e0d5><div class="item" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><a class="VPLink link link" href="/posts/xv6-trap.html" data-v-bd01e0d5><!--[--><p class="text" data-v-bd01e0d5>Exception and Interrupt Handling in xv6</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-bd01e0d5 data-v-bd01e0d5><div class="item" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><a class="VPLink link link" href="/posts/function-prologues.html" data-v-bd01e0d5><!--[--><p class="text" data-v-bd01e0d5>Function Prologues</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-9d8abc1e data-v-3cf691b6><div class="VPDoc has-sidebar has-aside" data-v-3cf691b6 data-v-a3c25e27><!--[--><!--]--><div class="container" data-v-a3c25e27><div class="aside" data-v-a3c25e27><div class="aside-curtain" data-v-a3c25e27></div><div class="aside-container" data-v-a3c25e27><div class="aside-content" data-v-a3c25e27><div class="VPDocAside" data-v-a3c25e27 data-v-cb998dce><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-cb998dce data-v-3a6c4994><div class="content" data-v-3a6c4994><div class="outline-marker" data-v-3a6c4994></div><div class="outline-title" role="heading" aria-level="2" data-v-3a6c4994>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-3a6c4994><span class="visually-hidden" id="doc-outline-aria-label" data-v-3a6c4994> Table of Contents for current page </span><ul class="root" data-v-3a6c4994 data-v-463da30f><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-cb998dce></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-a3c25e27><div class="content-container" data-v-a3c25e27><!--[--><!--]--><!----><main class="main" data-v-a3c25e27><div style="position:relative;" class="vp-doc _posts_xv6-trap" data-v-a3c25e27><div><h1 id="exception-and-interrupt-handling-in-xv6" tabindex="-1">Exception and Interrupt Handling in xv6 <a class="header-anchor" href="#exception-and-interrupt-handling-in-xv6" aria-label="Permalink to &quot;Exception and Interrupt Handling in xv6&quot;">​</a></h1><p>In this post, we will introduce how xv6 implement traps.</p><p>In [5], the designers of xv6 share the same understanding of <strong>trap</strong> as the RISC-V specification[4]. In this context, <strong>trap</strong> refers to the transfer of control to a trap handler, which can be triggered by an exception or an interrupt.</p><p>Consider calling the <code>freemem</code> system call to calculate the number of free pages.</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> num </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">freemem</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">&amp;</span><span style="color:#FFAB70;">num</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">fprintf</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;freemem failed!</span><span style="color:#79B8FF;">\\\\</span><span style="color:#9ECBFF;">n&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">exit</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">int</span><span style="color:#24292E;"> num </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">freemem</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">&amp;</span><span style="color:#E36209;">num</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">fprintf</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;freemem failed!</span><span style="color:#005CC5;">\\\\</span><span style="color:#032F62;">n&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">exit</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>What happens when the user calls <code>freemem</code>? In other words, to where is the control transferred?</p><p>In fact, the <code>freemem</code> function we call is a &quot;stub&quot; for the system call. Its function body is the following assembly code:</p><div class="language-assembly vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">assembly</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;"># user/usys.S</span></span>
<span class="line"><span style="color:#e1e4e8;">.global freemem</span></span>
<span class="line"><span style="color:#e1e4e8;">freemem:</span></span>
<span class="line"><span style="color:#e1e4e8;">	li a7, SYS_freemem</span></span>
<span class="line"><span style="color:#e1e4e8;">	ecall</span></span>
<span class="line"><span style="color:#e1e4e8;">	ret</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;"># user/usys.S</span></span>
<span class="line"><span style="color:#24292e;">.global freemem</span></span>
<span class="line"><span style="color:#24292e;">freemem:</span></span>
<span class="line"><span style="color:#24292e;">	li a7, SYS_freemem</span></span>
<span class="line"><span style="color:#24292e;">	ecall</span></span>
<span class="line"><span style="color:#24292e;">	ret</span></span></code></pre></div><p><code>SYS_freemem</code> is the system call number defined in <code>kernel/syscall.h</code>. In RISC-V, a system call is made by placing the system call number in register <code>a7</code> and executing an <code>ecall</code> instruction to jump to the trap handler.</p><blockquote><p>Before we move on to explore what happens in the trap handler, let&#39;s take a moment to explain why some readers of this post may not be able to find <code>usys.S</code> in <code>user</code>. This is because the file is dynamically generated by the Perl script <code>user/usys.pl</code>. The dynamic generation occurs during the kernel&#39;s make process, which means it can only be seen after running <code>make qemu</code> or other commands that execute the Perl script.</p></blockquote><p>Xv6 trap handling proceeds in four stages: (1) hardware actions taken by the RISC-V CPU, (2) an assembly “vector” that prepares the way for kernel C code, (3) a C trap handler that decides what to do with the trap, and (4) the system call or device-driver service routine [5].</p><h2 id="phase-1-hardware-actions-taken-by-the-risc-v-cpu" tabindex="-1">Phase 1: hardware actions taken by the RISC-V CPU <a class="header-anchor" href="#phase-1-hardware-actions-taken-by-the-risc-v-cpu" aria-label="Permalink to &quot;Phase 1: hardware actions taken by the RISC-V CPU&quot;">​</a></h2><p>We have executed the <code>ecall</code> instruction and the hardware begins to take control, subsequently transferring the control flow to the trap handler. The sequence of hardware actions includes procedures that manipulate registers in order to prepare for the trap handler. Therefore, we will first introduce some registers that will be manipulated in the hardware actions phase and subsequent phases.</p><ul><li><p><code>stvec</code>: The kernel writes the address of its trap handler here; the RISC-V jumps here to handle a trap.</p></li><li><p><code>sepc</code>: When a trap occurs, RISC-V saves the program counter here (since the <code>pc</code> is then overwritten with <code>stvec</code>). The <code>sret</code> (return from trap) instruction copies <code>sepc</code> to the <code>pc</code>. The kernel can write to <code>sepc</code> to control where <code>sret</code> goes.</p></li><li><p><code>scause</code>: The RISC-V puts a number here that describes the reason for the trap.</p></li><li><p><code>sscratch</code>: The kernel places a value here that comes in handy at the very start of a trap handler.</p></li><li><p><code>sstatus</code>: The SIE bit in sstatus controls whether device interrupts are enabled. If the kernel clears SIE, the RISC-V will defer device interrupts until the kernel sets SIE. The SPP bit indicates whether a trap came from user mode or supervisor mode, and controls to what mode sret returns.</p></li></ul><p>Here, the leading &#39;s&#39; in the names of the registers means supervisor mode, which is above the user and machine modes.</p><p>When it needs to force a trap, the RISC-V hardware does the following for all trap types (other than timer interrupts):</p><ol><li>If the trap is a device interrupt, and the <code>sstatus</code> SIE bit is clear, don’t do any of the following.</li><li>Disable interrupts by clearing SIE.</li><li>Copy the <code>pc</code> to<code>sepc</code>.</li><li>Save the current mode (user or supervisor) in the SPP bit in <code>sstatus</code>.</li><li>Set <code>scause</code> to reflect the trap’s cause.</li><li>Set the mode to supervisor.</li><li>Copy <code>stvec</code> to the <code>pc</code>.</li></ol><p>The actions performed by hardware are now clear. However, one question remains: when does the kernel write the address of its trap handler into <code>stvec</code>? This is a non-trivial question.</p><p>In the xv6 book [5], traps can be classified into two classes: traps from user space and traps from kernel space. The former include interrupts, exceptions, or system calls from user space, while the latter include interrupts and exceptions from kernel space. It is important to note that exceptions from kernel space are unacceptable and will cause the kernel to panic.</p><p><strong>For traps from user space</strong>, the routine of setting <code>stvec</code> to <code>uservec</code> occurs during the creation of new processes. Specifically, <code>stvec</code> is set to <code>trampoline_uservec</code> in the <code>usertrapret</code> function, which is called in <code>forkret</code>. <code>forkret</code> serves as the entry point for a new process. In summary, <code>stvec</code> is set to the user trap handler when a user process starts to run. <strong>For traps from kernel space</strong>, it is less subtle and clear in the source code.</p><h2 id="phase-2-an-assembly-vector-that-prepares-the-way-for-kernel-c-code" tabindex="-1">Phase 2: an assembly “vector” that prepares the way for kernel C code <a class="header-anchor" href="#phase-2-an-assembly-vector-that-prepares-the-way-for-kernel-c-code" aria-label="Permalink to &quot;Phase 2: an assembly “vector” that prepares the way for kernel C code&quot;">​</a></h2><p>Do you still remember the four phases mentioned above? Now that the actions performed by the hardware are complete, we have jumped to the address specified in <code>stvec</code>. This address is referred to as <strong>an assembly &quot;vector&quot; that prepares the way for kernel C code</strong>.</p><blockquote><p>...</p><p>Xv6 satisfies these constraints with a <em><strong>trampoline</strong></em> page that contains <code>uservec</code>. Xv6 maps the trampoline page at the same virtual address in the kernel page table and in every user page table. This virtual address is <code>TRAMPOLINE</code> (as we saw in Figure 2.3 and in Figure 3.3). The trampoline contents are set in <code>trampoline.S</code>, and (when executing user code) <code>stvec</code> is set to <code>uservec</code> (kernel/trampoline.S:16).</p></blockquote><p>The assembly code for <code>uservec</code> is clear enough with comments. Each process has a virtual memory area called <code>TRAPFRAME</code> where contexts from user space are saved. After the registers have been saved, the kernel stack pointer, page table, and hart id are fetched from <code>TRAPFRAME</code>, and the control is transferred to <code>usertrap</code> now.</p><h2 id="phase-3-a-c-trap-handler-that-decides-what-to-do-with-the-trap" tabindex="-1">Phase 3: a C trap handler that decides what to do with the trap <a class="header-anchor" href="#phase-3-a-c-trap-handler-that-decides-what-to-do-with-the-trap" aria-label="Permalink to &quot;Phase 3: a C trap handler that decides what to do with the trap&quot;">​</a></h2><p>The C trap handler determines the cause of this trap by reading <code>scause</code>. The return address should be set to the next instruction if the trap is a system call. After the trap handler has determined that the trap is a system call, control is transferred to <code>syscall</code>, which will call the predefined system call function according to the system call number specified in <code>a7</code>.</p><h2 id="phase-4-the-system-call-or-device-driver-service-routine" tabindex="-1">Phase 4: the system call or device-driver service routine <a class="header-anchor" href="#phase-4-the-system-call-or-device-driver-service-routine" aria-label="Permalink to &quot;Phase 4: the system call or device-driver service routine&quot;">​</a></h2><p>This is where the system call code is executed. To find the corresponding system call code, the system call number is used to index into a function pointer array and retrieve the appropriate function pointer. The system call functions are defined in <code>sysproc.c</code>.</p><p>Note that if the system call is made by <code>freemem(&amp;num)</code>, which means we have to copy the number of free pages to <code>num</code>, the difference in page tables should be taken into consideration. Because in the kernel, we have a different virtual memory space from the user, which means that we have to consult the virtual memory address of the user process that made the system call to copy the value to the right place.</p><p>This can be done by the following code:</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">struct</span><span style="color:#E1E4E8;"> proc </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">p </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">myproc</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">uint64 addr;</span></span>
<span class="line"><span style="color:#B392F0;">argaddr</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">&amp;</span><span style="color:#FFAB70;">addr</span><span style="color:#E1E4E8;">);</span><span style="color:#6A737D;"> // get parameter 0, which is the address of `num`</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">copyout</span><span style="color:#E1E4E8;">(p</span><span style="color:#F97583;">-&gt;</span><span style="color:#FFAB70;">pagetable</span><span style="color:#E1E4E8;">, addr, (</span><span style="color:#F97583;">char</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">&amp;</span><span style="color:#FFAB70;">sum</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">sizeof</span><span style="color:#E1E4E8;">(sum)) </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">struct</span><span style="color:#24292E;"> proc </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">p </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">myproc</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">uint64 addr;</span></span>
<span class="line"><span style="color:#6F42C1;">argaddr</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">&amp;</span><span style="color:#E36209;">addr</span><span style="color:#24292E;">);</span><span style="color:#6A737D;"> // get parameter 0, which is the address of `num`</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">copyout</span><span style="color:#24292E;">(p</span><span style="color:#D73A49;">-&gt;</span><span style="color:#E36209;">pagetable</span><span style="color:#24292E;">, addr, (</span><span style="color:#D73A49;">char</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">&amp;</span><span style="color:#E36209;">sum</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">sizeof</span><span style="color:#24292E;">(sum)) </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span></code></pre></div><p>Above are the four phases of making and executing system calls in xv6. Handling user space interrupts and exceptions are similar in terms of the four phases. Returning from a trap is all about recovering the user contexts and is similar to saving contexts. The control is transferred from <code>usertrapret</code> to <code>userret</code>, and finally, to the next instructions of the instruction that causes the system call.</p><h2 id="references" tabindex="-1">References <a class="header-anchor" href="#references" aria-label="Permalink to &quot;References&quot;">​</a></h2><p><strong>1</strong> OS-23Fall-FDU Repository <a href="https://github.com/idlebo/OS-23Fall-FDU/blob/lab3/doc/trap.explained.md" target="_blank" rel="noreferrer">https://github.com/idlebo/OS-23Fall-FDU/blob/lab3/doc/trap.explained.md</a></p><p><strong>2</strong> Intel® 64 and IA-32 Architectures Software Developer Manuals <a href="https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html" target="_blank" rel="noreferrer">https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html</a></p><p><strong>3</strong> AArch64 Exception and Interrupt Handling <a href="https://developer.arm.com/documentation/100933/0100/AArch64-Exception-and-Interrupt-Handling" target="_blank" rel="noreferrer">https://developer.arm.com/documentation/100933/0100/AArch64-Exception-and-Interrupt-Handling</a></p><p><strong>4</strong> RISC-V Specifications <a href="https://riscv.org/technical/specifications/" target="_blank" rel="noreferrer">https://riscv.org/technical/specifications/</a></p><p><strong>5</strong> Xv6, a simple Unix-like teaching operating system <a href="http://pdos.csail.mit.edu/6.828/2012/xv6.html" target="_blank" rel="noreferrer">http://pdos.csail.mit.edu/6.828/2012/xv6.html</a></p></div></div></main><footer class="VPDocFooter" data-v-a3c25e27 data-v-a2d931e4><!--[--><!--]--><!----><nav class="prev-next" data-v-a2d931e4><div class="pager" data-v-a2d931e4><a class="pager-link prev" href="/posts/monitor.html" data-v-a2d931e4><span class="desc" data-v-a2d931e4>Previous page</span><span class="title" data-v-a2d931e4>Monitor, Condition Variables and Three Semantics</span></a></div><div class="pager" data-v-a2d931e4><a class="pager-link next" href="/posts/function-prologues.html" data-v-a2d931e4><span class="desc" data-v-a2d931e4>Next page</span><span class="title" data-v-a2d931e4>Function Prologues</span></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"papers_clof.md\":\"44d957b6\",\"papers_treesls.md\":\"7c7057bf\",\"posts_function-prologues.md\":\"b764e00b\",\"papers_transactional-memory.md\":\"5cfb513d\",\"papers_kuber-scheduling.md\":\"ca7bae1a\",\"posts_xv6-trap.md\":\"2fe1f712\",\"index.md\":\"2af00d05\",\"posts_monitor.md\":\"6d59b01b\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Yi Sun's Blog\",\"description\":\"This is Yi Sun's blog.\",\"base\":\"/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"Me\",\"link\":\"/\"},{\"text\":\"Posts\",\"link\":\"/posts/monitor\"},{\"text\":\"Paper Reading\",\"link\":\"/papers/TreeSLS\"}],\"sidebar\":{\"/\":{\"text\":\"Me\",\"items\":[{\"text\":\"Biograhy\",\"link\":\"/\"}]},\"/posts/\":{\"text\":\"Operating Systems\",\"items\":[{\"text\":\"Monitor, Condition Variables and Three Semantics\",\"link\":\"/posts/monitor\"},{\"text\":\"Exception and Interrupt Handling in xv6\",\"link\":\"/posts/xv6-trap\"},{\"text\":\"Function Prologues\",\"link\":\"/posts/function-prologues\"}]},\"/papers/\":[{\"text\":\"Operating Systems\",\"items\":[{\"text\":\"TreeSLS\",\"link\":\"/papers/TreeSLS\"},{\"text\":\"Transactional Memory\",\"link\":\"/papers/transactional-memory\"},{\"text\":\"Kubernetes Scheduling\",\"link\":\"/papers/kuber-scheduling\"},{\"text\":\"CLoF\",\"link\":\"/papers/CLoF\"}]},{\"text\":\"NLP\",\"items\":[]}]},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/boreas618\"}]},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":false}");</script>
    
  </body>
</html>